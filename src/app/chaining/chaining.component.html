<div class="row unit form-group">
  <div class="chainParameters" #chainDiv>
    <div class="topBlock verticalTop littleMarginBottom" *ngFor="let i of [0,1]">
      <div class="inlineBlock verticalTop">

        <div class="selectUnitZone">
          <button *ngIf="chain[i] || bestChainers[0]" type="button" class="btn btn-secondary btnDelete" (click)="unselectUnit(i)">X</button>

          <div class="inlineBlock firstSelectLevel" *ngIf="i === 0 || (chain[0] && !bestChainers[0])">
            <label *ngIf="!chain[i] || (chain[i] && !chain[i].activeRename)" for="chain{{i}}">Unit {{ i + 1 }}</label>
            <div *ngIf="!chain[i] || chain[i].id < 10000">
              <select class="form-control" id="chain{{i}}" [(ngModel)]="selectedUnits[i]" (ngModelChange)="onChangeUnit(i)">
                <option value="" selected>Predefined units</option>
                <option *ngFor="let unit of units | type:'chain'" [ngValue]="unit">{{ unit.name | capitalize}}</option>
              </select>
              <img class="unitImg" src='assets/units/{{ chain[i].id }}.png' *ngIf="chain[i]" />
            </div>

            <div *ngIf="(!chain[i] || (chain[i].id > 10000 && !chain[i].activeRename)) && createdUnits && createdUnits.length > 0" [ngClass]="{ 'littleMarginTop': !chain[i]}">
              <select class="form-control" id="chain{{i}}" [(ngModel)]="selectedUnits[i]" (ngModelChange)="onChangeUnit(i)">
                <option value="" selected>My units</option>
                <option *ngFor="let unit of createdUnits | type:'chain'" [ngValue]="unit">{{ unit.name | capitalize}}</option>
              </select>
              <button *ngIf="chain[i] && !chain[i].activeRename" class="btn btn-secondary fullWidth littleMarginTop" type="button" (click)="renameUnit(i)">Rename</button>
              <button *ngIf="chain[i]" class="btn btn-secondary fullWidth littleMarginTop" type="button" (click)="saveUnit(i)">Save</button>
            </div>

            <div *ngIf="chain[i] && chain[i].activeRename">
              <label for="chainer{{i}}_name">Unit name {{ i + 1 }}</label>
              <input class="form-control" type="text" id="chainer{{i}}_name" [(ngModel)]="chain[i].name" (ngModelChange)="onChangeChain()" (keyup.enter)="saveUnit(i)">
              <button class="btn btn-secondary fullWidth littleMarginTop" type="button" (click)="saveUnit(i)">Save</button>
            </div>

            <div class="selectRightZoneOneThird mobileNoMarginTop tabletNoMarginLeft" *ngIf="chain[i] && chain[i].id > 10000">
              <button class="btn btn-secondary fullWidth littleMarginTop" type="button" (click)="removeUnit(i)">Remove Unit</button>
            </div>

            <div class="selectRightZoneOneThird buttonsUnit mobileNoMarginTop" *ngIf="chain[i] && !viewOptions[i]">
              <hr class="selectHrWithBottomMargin"/>
              <label for="chainer{{i}}_ability">Ability</label>
              <select class="form-control" id="chainer{{i}}_ability" [(ngModel)]="selectedAbilities[i]" (ngModelChange)="onChangeSkill(i)">
                <option *ngFor="let ability of chain[i].abilities; let j = index" [ngValue]="j">{{ ability.name | capitalize }}</option>
              </select>
            </div>

            <div *ngIf="!chain[i]">
              <hr class="selectHr"/>
              <button class="btn btn-secondary fullWidth littleMarginTop" type="button" (click)="createNewUnit(i)">Create New Unit</button>
            </div>

            <div *ngIf="chain[i] && viewOptions[i]">
              <hr class="selectHr"/>
              <button class="btn btn-secondary fullWidth littleMarginTop" type="button" (click)="createNewUnitFromPredefined(i)">Clone To My Unit</button>
            </div>

            <div *ngIf="chain[i - 1] && !chain[i]">
              <button class="btn btn-secondary fullWidth littleMarginTop" type="button" (click)="duplicateUnit()">Duplicate Unit 1</button>
            </div>

            <hr class="selectHr" *ngIf="chain[i]"/>

            <button class="btn btn-secondary fullWidth littleMarginTop" type="button" (click)="showOptions(i)" *ngIf="chain[i]">
              {{ viewOptions[i] ? 'Hide' : 'Show' }} Options
            </button>

            <hr class="selectHr" *ngIf="chain[i - 1] && !chain[i]"/>

            <button class="btn btn-secondary fullWidth littleMarginTop" type="button" (click)="findBestChainers()" *ngIf="chain[i - 1] && !chain[i]">
              Find Best Chainers
            </button>
          </div>

          <div class="inlineBlock firstSelectLevel" *ngIf="i == 1 && bestChainers[0] && !chain[i]">
            <label>Best chainers</label>
            <button
              *ngFor="let chainer of bestChainers; let j = index"
              class="btn btn-secondary fullWidth"
              [ngClass]="{'littleMarginTop': j !== 0}"
              type="button"
              (click)="selectUnit(1, chainer.unit, chainer.ability, chainer.frames)"
            >
              <div class="bestChainerButton">
                {{ chainer.unit.name }}<br />
                <span>
                  {{ chainer.ability.name }}<br />
                  {{ chainer.modifier }}%
                </span>
              </div>
            </button>
          </div>

          <div *ngIf="i === 1 && !chain[0]">
            <label>Unit 2</label><br />
            <i class="fa fa-ban selectUnit1" aria-hidden="true"></i><br />
            Select unit 1 first !
          </div>

          <div class="selectRightZone inlineBlock verticalTop" *ngIf="chain[i] && viewOptions[i]">
            <hr class="mobileSeparatorSelectRightZone"/>
            <div class="selectRightZoneBox">
              <div class="selectRightZoneOneThird">
                <label for="chainer{{i}}_dual">Dualcast/Dualwield</label>
                <select class="form-control" id="chainer{{i}}_dual" [(ngModel)]="chain[i].dual" (ngModelChange)="onChangeDual(i)">
                  <option [ngValue]="true">Yes</option>
                  <option [ngValue]="false">No</option>
                </select>
              </div>

              <div class="selectRightZoneOneThird">
                <label for="chainer{{i}}_weapon1">Element weapon 1</label>
                <select class="form-control" id="chainer{{i}}_weapon1" [(ngModel)]="chain[i].weapons[0]" (ngModelChange)="saveUnit(i)">
                  <option *ngFor="let element of elements" [ngValue]="element">{{element}}</option>
                </select>
              </div>

              <div class="selectRightZoneOneThird tabletMarginTop" *ngIf="chain[i].dual">
                <label for="chainer{{i}}_weapon2">Element weapon 2</label>
                <select class="form-control" id="chainer{{i}}_weapon2" [(ngModel)]="chain[i].weapons[1]" (ngModelChange)="saveUnit(i)">
                  <option *ngFor="let element of elements" [ngValue]="element">{{element}}</option>
                </select>
              </div>
            </div>

            <hr />

            <div class="selectRightZoneBox littleMarginTop">
              <div class="selectRightZoneOneThird selectAbility" *ngIf="!chain[i].ability.activeRename">
                <label for="chainer{{i}}_ability">Ability</label>
                <select class="form-control" id="chainer{{i}}_ability" [(ngModel)]="selectedAbilities[i]" (ngModelChange)="onChangeSkill(i)">
                  <option *ngFor="let ability of chain[i].abilities; let j = index" [ngValue]="j">{{ability.name}}</option>
                </select>
              </div>

              <div class="selectRightZoneOneThird selectAbility" *ngIf="chain[i].ability.activeRename">
                <label for="unit_ability">Ability name</label>
                <input class="form-control" type="text" id="unit_ability" [(ngModel)]="chain[i].ability.name" (keyup.enter)="saveUnit(i)">
              </div>

              <diV class="buttonsAbility">
                <div class="selectRightZoneTwoThirdDividedInThird" *ngIf="chain[i].id > 10000 && !chain[i].ability.activeRename">
                  <label class="emptyLabel">&nbsp;</label>
                  <button class="btn btn-secondary fullWidth" type="button" (click)="renameAbility(i)">Rename ability</button>
                </div>

                <div class="selectRightZoneTwoThirdDividedInThird" *ngIf="chain[i].id > 10000 && chain[i].ability.activeRename">
                  <label class="emptyLabel">&nbsp;</label>
                  <button class="btn btn-secondary fullWidth" type="button" (click)="saveUnit(i)">Save ability</button>
                </div>

                <div class="selectRightZoneTwoThirdDividedInThird">
                  <label class="emptyLabel">&nbsp;</label>
                  <button class="btn btn-secondary fullWidth" type="button" (click)="addAbility(i)">Add ability</button>
                </div>

                <div class="selectRightZoneTwoThirdDividedInThird" *ngIf="chain[i].abilities.length > 1">
                  <label class="emptyLabel">&nbsp;</label>
                  <button class="btn btn-secondary fullWidth" type="button" (click)="removeAbility(i)">Delete ability</button>
                </div>
              </diV>
            </div>

            <div class="selectRightZoneBox littleMarginTop">
              <div class="selectRightZoneOneThird">
                <span id="tooltip_base_{{i}}"></span>
                <label for="chainer{{i}}_base"
                  tooltip="ex: damage 7x = 700%"
                  parentSelector="#tooltip_base_{{i}}">
                  Base % <i class="fa fa-info-circle helperIcon" aria-hidden="true"></i>
                </label>
                <div class="input-group">
                  <input class="form-control" type="number" id="chainer{{i}}_base" [(ngModel)]="chain[i].ability.base" (ngModelChange)="saveUnit(i)">
                  <span class="input-group-addon" id="unit_base_percent">%</span>
                </div>
              </div>

              <div class="selectRightZoneOneThird">
                <label for="chainer{{i}}_ignore">Ignore (Def/Spr)</label>
                <div class="input-group">
                  <input class="form-control" type="number" id="chainer{{i}}_ignore" [(ngModel)]="chain[i].ability.ignore" (ngModelChange)="saveUnit(i)">
                  <span class="input-group-addon" id="unit_base_percent">%</span>
                </div>
              </div>

              <div class="selectRightZoneOneThird tabletMarginTop">
                <span id="tooltip_type_{{i}}"></span>
                <label for="chainer{{i}}_type"
                  tooltip="physic if weapon element is applied to the ability"
                  parentSelector="#tooltip_type_{{i}}"
                  tooltipClass="tooltip-ability-type">
                  Type <i class="fa fa-info-circle helperIcon" aria-hidden="true"></i>
                </label>
                <select class="form-control" id="chainer{{i}}_type" [(ngModel)]="chain[i].ability.type" (ngModelChange)="saveUnit(i)">
                  <option *ngFor="let abilityType of abilityTypes" [ngValue]="abilityType">{{abilityType}}</option>
                </select>
              </div>
            </div>

            <div class="selectRightZoneBox littleMarginTop">
              <div class="selectRightZoneMediumBox verticalTop blockLinearFrames tabletMarginLeft">
                <label for="chainer{{i}}_frames">Linear Frames</label>
                <div>
                  <input type="checkbox" id="chainer{{i}}_linearFrames" [(ngModel)]="chain[i].ability.linearFrames" (ngModelChange)="saveUnit(i)">
                  <label for="chainer{{i}}_linearFrames"></label>
                </div>
              </div>

              <div class="selectRightZoneLittleBox" *ngIf="chain[i].ability.linearFrames">
                <label for="chainer{{i}}_hits">Hits</label>
                <input class="form-control" type="number" id="chainer{{i}}_hits" [(ngModel)]="chain[i].ability.hits" (ngModelChange)="saveUnit(i)">
              </div>

              <div class="selectRightZoneTwoThirdDividedInThird" *ngIf="chain[i].ability.linearFrames">
                <label for="chainer{{i}}_frames">Hit X Frames</label>
                <input class="form-control" type="number" id="chainer{{i}}_frames" [(ngModel)]="chain[i].ability.frames" (ngModelChange)="saveUnit(i)">
              </div>

              <div class="selectRightZoneFrames" *ngIf="!chain[i].ability.linearFrames">
                <label for="chainer{{i}}_framesList">Frames (0-X-X-X-X)</label>
                <input class="form-control" type="text" id="chainer{{i}}_framesList" [(ngModel)]="chain[i].ability.framesList" (ngModelChange)="saveUnit(i)">
              </div>

              <div class="selectRightZoneLittleBox tabletMarginTop tabletMarginLeft">
                <label for="chainer{{i}}_firstHit">First Hit</label>
                <input class="form-control" type="number" id="chainer{{i}}_firstHit" [(ngModel)]="chain[i].ability.firstHit" (ngModelChange)="saveUnit(i)">
              </div>

              <div class="selectRightZoneLittleBox">
                <label for="chainer{{i}}_castTime">Cast time</label>
                <input class="form-control" type="number" id="chainer{{i}}_castTime" [(ngModel)]="chain[i].ability.castTime" (ngModelChange)="saveUnit(i)">
              </div>

              <div class="selectRightZoneLittleBox">
                <label for="chainer{{i}}_offset">Offset</label>
                <input class="form-control" type="number" id="chainer{{i}}_offset" [(ngModel)]="chain[i].ability.offset" (ngModelChange)="saveUnit(i)">
              </div>
            </div>

            <div class="selectRightZoneBox littleMarginTop multiSelectDropdown tabletMarginLeft" *ngIf="multiElements.length > 0">
              <ss-multiselect-dropdown
                [options]="multiElements"
                [settings]="multiElementsSettings"
                [texts]="multiElementsTexts"
                [(ngModel)]="this.chain[i].ability.elements"
                (ngModelChange)="saveUnit(i)">
              </ss-multiselect-dropdown>
            </div>

            <div class="selectRightZoneBox littleMarginTop tabletMarginLeft">
              <hr class="mobileSeparatorSelectDebuff"/>
              <button class="btn btn-secondary btnAddDebuff" type="button" (click)="addDebuff(i)">Add debuff</button>
              <div *ngFor="let debuff of chain[i].debuffs; let j = index" class="selectRightZoneDividedTwo littleMarginTop">
                <hr class="mobileSeparatorSelectDebuff tabletNoMarginTop"/>
                <div class="selectRightZoneTwoDividedThree">
                  <label for="unit{{i}}_debuff{{j}}_type">Element {{j + 1}}</label>
                  <select class="form-control" id="unit{{i}}_debuff{{j}}_type" [(ngModel)]="chain[i].debuffs[j].type" (ngModelChange)="onChangeDebuff(i, j)">
                    <option *ngFor="let element of requiredElements" [ngValue]="element">{{element}}</option>
                  </select>
                </div>
                <div class="selectRightZoneTwoDividedThree">
                  <label for="unit{{i}}_debuff{{j}}_value">Value {{j + 1}}</label>
                  <div class="input-group">
                    <input class="form-control" type="number" id="unit{{i}}_debuff{{j}}_value" [(ngModel)]="chain[i].debuffs[j].value" (ngModelChange)="onChangeDebuff(i, j)">
                    <span class="input-group-addon" id="unit_base_percent">%</span>
                  </div>
                </div>
                <div class="selectRightZoneTwoDividedThree">
                  <button class="btn btn-secondary fullWidth" type="button" (click)="removeDebuff(i, j)">Remove</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="i === 0 && chain[1]" class="topBlock" [ngClass]="
        {'zoneSwitchWithoutOptions': !viewOptions[0] && !viewOptions[1],
         'zoneSwitchWithOneOptions': viewOptions[0] || viewOptions[1],
         'zoneSwitchWithFullOptions': viewOptions[0] && viewOptions[1]
        }">
        <button type="button" class="btn btn-secondary btnSwitch" (click)="switchUnits()">
          <i class="fa fa-exchange" aria-hidden="true" [ngClass]="{'fa-rotate-90': viewOptions[0] || viewOptions[1]}"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="row" *ngIf="chain[1]">
  <div class="selectChainZone">
    <div class="selectSlider">
      <label>Difference in first hit frame</label>
      <nouislider [config]="sliderConfig" [(ngModel)]="framesGap" (ngModelChange)="onChangeChain()"></nouislider>
      <button class="btn btn-secondary fullWidth" type="button" (click)="findBestFrames()">Find best frame difference</button>
    </div>
    <div class="selectFramesGap">
      <label>Difference in first hit frame</label>
      <div class="input-group">
        <span class="input-group-btn">
          <button type="button" class="btn btn-default btn-number" (click)="updateFramesGap(false)">
            <i class="fa fa-minus" aria-hidden="true"></i>
          </button>
        </span>
        <input class="form-control inputFramesGap" type="number" id="chain_framesGap" [(ngModel)]="framesGap" (ngModelChange)="checkFramesGap()">
        <span class="input-group-btn">
          <button type="button" class="btn btn-default btn-number" (click)="updateFramesGap(true)">
            <i class="fa fa-plus" aria-hidden="true"></i>
          </button>
        </span>
      </div>
      <button class="btn btn-secondary fullWidth tabletMarginTop" type="button" (click)="findBestFrames()">Find best frame difference</button>
    </div>
  </div>
</div>

<div class="row littleMarginTop" *ngIf="chain[0]">
  <div class="selectDetailZone">
    <h2>Result</h2>
    <p *ngIf="chain[0].ability.type !== 'hybrid' && (!chain[1] || chain[1].ability.type !== 'hybrid')">
      Total modifier : {{chainService.getResult().modifier}}%
    </p>
    <p *ngIf="chain[1]">
      Total combo : {{chainService.getResult().combo}}
    </p>
    <p *ngIf="chain[1]">
      <span *ngIf="chainService.getDiffFirstHits() === 0">
        Both units must be sent on the same frame
      </span>
      <span *ngIf="chainService.getDiffFirstHits() > 0">
        {{chain[0].name}} must be sent {{chainService.getDiffFirstHits()}} frames ({{chainService.getDiffFirstHits() * 1 / 60 * 1000 | round}}ms) before {{chain[1].name}}
      </span>
      <span *ngIf="chainService.getDiffFirstHits() < 0">
        {{chain[1].name}} must be sent {{-chainService.getDiffFirstHits()}} frames ({{-chainService.getDiffFirstHits() * 1 / 60 * 1000 | round}}ms) before {{chain[0].name}}
      </span>
    </p>
  </div>
</div>

<app-chain-chart *ngIf="chain[0]"></app-chain-chart>
<div *ngIf="chain[0]">
  <p>Legend</p>
  <div class="legendColorBlock">
    <div class="legendColor legendClassic1"></div>
    <div class="legendColor legendClassic2"></div>
    <div>Unit classic hit</div>
  </div>
  <div class="legendColorBlock">
    <div class="legendColor legendDual1"></div>
    <div class="legendColor legendDual2"></div>
    <div>Unit hit from dual</div>
  </div>
  <div class="legendColorBlock">
    <div class="legendColor legendBreak1"></div>
    <div class="legendColor legendBreak2"></div>
    <div>Unit hit break chain</div>
  </div>
</div>
