<div class="row">
  <div class="searchBlock">
    <i class="fas fa-search" aria-hidden="true"></i>
    <input class="searchInput" type="text" placeholder="Search for an unit by name" [(ngModel)]="searchText" (ngModelChange)="updateFilteredUnits()" (blur)="blurSearch()" (focus)="focusSearch()" />
    <i class="fas fa-times" aria-hidden="true" (click)="selectUnit('')"></i>
    <i class="fas fa-chevron-up" aria-hidden="true" (click)="toogleList()" *ngIf="showList"></i>
    <i class="fas fa-chevron-down" aria-hidden="true" (click)="toogleList()" *ngIf="!showList"></i>
  </div>

  <div class="loadingBlock" *ngIf="loadingBuild">
    <h1>Your build is loading</h1>
    <i class="fas fa-spinner fa-pulse fa-5x fa-fw" aria-hidden="true"></i>
  </div>

  <div class="rarityBlock" *ngFor="let rarity of ['UR', 'MR', 'SR', 'R', 'N']">
    <div class="rarityLine" *ngIf="showList && !loadingBuild && filteredUnits[rarity].length > 0">
      <img src="assets/rarity/{{rarity}}.png" /><span>{{ rarityTranslate[rarity] }}</span>
    </div>
    <div class="unitBlock" *ngIf="showList && !loadingBuild && filteredUnits[rarity].length > 0">
      <div class="unitLine" *ngFor="let filteredUnit of filteredUnits[rarity]; let j = index">
        <div class="unitSelector" [ngClass]="{'unitSelectorWithSave': savedUnits[filteredUnit.dataId]}" (click)="selectUnit(filteredUnit.dataId)">
          <div class="unitLogo">
            <img src="assets/units/{{ filteredUnit.image }}_m.png" />
          </div>
          <div class="unitName" innerHTML="{{ filteredUnit.name | highlight: searchText }}"></div>
        </div>
        <div class="loadDiv" *ngIf="savedUnits[filteredUnit.dataId] && savedUnits[filteredUnit.dataId].length > 0">
          <a (click)="openLoadModal(filteredUnit.dataId)"><i class="fas fa-download"></i></a>
        </div>
        <hr *ngIf="j != filteredUnits[rarity].length - 1"/>
      </div>
    </div>
  </div>

  <div class="saveBlock" *ngIf="!showList && unit">
    <button class="btn btn-sub btn-buildLink" (click)="openLinkModal(builderLink)">Get Build Link</button>
    <button class="btn btn-sub" (click)="openSaveModal(saveModal)" *ngIf="showSave">Save</button>
  </div>

  <div class="leftBlock" *ngIf="!showList && unit">
    <table>
      <tbody>
        <tr>
          <th>{{ unit.name }}<span *ngIf="unit.customName"> - {{ unit.customName }}</span></th>
        </tr>
        <tr>
          <td>
            <div class="unitButtons">
              <button class="btn btn-sub btn-left" (click)="resetUnit()">Reset</button>
              <button class="btn btn-main btn-right" (click)="maxUnit()">Max unit</button>
            </div>
            <div class="cardIcons">
              <img class="rarityImg" src="{{'assets/rarity/' + unit.rarity + '.png'}}" />
              <img class="elementImg" src="{{'assets/elements/' + unit.element + '.png'}}"  />
            </div>
            <div>
              <img class="unitImg" src="assets/units/{{ unit.image }}_m.png" />
            </div>
          </td>
        </tr>
        <tr>
          <th class="sub">Level</th>
        </tr>
        <tr>
          <td>
            <div class="awakeningDiv">
              <div>
                Awakening
              </div>
              <div class="stars">
                <ngb-rating [(rate)]="unit.star" [max]="6" class="ratingStars">
                  <ng-template let-fill="fill" let-index="index">
                    <div class="star" [class.filled]="fill === 100"  (click)="changeStar(index + 1)">&nbsp;</div>
                  </ng-template>
                </ngb-rating>
              </div>
            </div>

            <div class="lbDiv">
              <div>
                Limit Break
              </div>
              <div class="lbs">
                <ngb-rating [(rate)]="unit.lb" [max]="5">
                  <ng-template let-fill="fill" let-index="index">
                    <div class="lb" [class.filled]="fill === 100" (click)="changeLB(index + 1)">&nbsp;</div>
                  </ng-template>
                </ngb-rating>
              </div>
            </div>

            <div class="levelDiv">
              <div>
                Level
              </div>
              <div ngbDropdown class="dropdownDiv">
                <button class="btn btn-select" ngbDropdownToggle>{{ unit.level }}</button>
                <div ngbDropdownMenu class="selectList">
                  <button *ngFor="let level of unit.tableLevels" class="selectLevel" ngbDropdownItem (focus)="selectLevel(level)">{{ level }}</button>
                </div> / {{ unit.maxLevel }}
              </div>
            </div>

            <div class="masterSkillDiv">
              <div>
                Master Skill Level
              </div>
              <div ngbDropdown class="dropdownDiv">
                <button class="btn btn-select" ngbDropdownToggle>{{ unit.masterSkillActivated + 1 }}</button>
                <div ngbDropdownMenu class="selectList">
                  <button *ngFor="let level of unit.masterSkillLevel" class="selectLevel" ngbDropdownItem (focus)="selectMasterSkillLevel(level)">{{ level + 1 }}</button>
                </div>
              </div>
            </div>

            <div class="limitDiv" *ngIf="unit.limit">
              <div>
                Limit Level
              </div>
              <div ngbDropdown class="dropdownDiv">
                <button class="btn btn-select" ngbDropdownToggle>{{ unit.limit.level }}</button>
                <div ngbDropdownMenu class="selectList">
                  <button *ngFor="let level of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]" class="selectLevel" ngbDropdownItem (focus)="selectLimitLevel(level)">{{ level }}</button>
                </div>
              </div>
            </div>

            <div>
              <button class="btn btn-sub btn-left" (click)="resetLevel()">Reset level</button>
              <button class="btn btn-main btn-right" (click)="maxLevelAndJobs()">Max level</button>
            </div>
          </td>
        </tr>
        <tr>
          <th class="sub">Jobs</th>
        </tr>
        <tr>
          <td>
            <div *ngFor="let i of [0, 1, 2]" class="jobDiv" [ngClass]="{'lastJobDiv': i == 2, 'subjobDisable': !unit.jobsData[i].unlocked}">
              <img [className]="i == 0 ? 'mainJob' : 'subJob'" src="{{'assets/jobs/' + unit.jobsData[i].image + '.png'}}" />

              <div ngbDropdown class="dropdownDiv">
                <button class="btn btn-select" ngbDropdownToggle [disabled]="!unit.jobsData[i].unlocked">{{ unit.jobsData[i].level }}</button>
                <div ngbDropdownMenu class="selectList">
                  <button *ngFor="let level of unit.tableJobLevels" class="selectLevel" ngbDropdownItem (focus)="selectJobLevel(i, level)">{{ level }}</button>
                </div>
              </div>
            </div>
            <div class="jobsButton">
              <button class="btn btn-sub btn-left" (click)="resetJob()">Reset Jobs</button>
              <button class="btn btn-main btn-right" (click)="maxLevelAndJobs()">Max Jobs</button>
            </div>
          </td>
        </tr>
        <tr>
          <th class="sub">Sub Job</th>
        </tr>
        <tr>
          <td class="subJobColumn">
            <div *ngFor="let i of [0, 1, 2]" class="subjobDiv jobDiv" [ngClass]="{'lastJobDiv': i == 2, 'selectedSubJob': i == unit.subjob, 'subjobDisable': !unit.jobsData[i].unlocked}" (click)="selectSubJob(i)">
              <img class="subJob" src="{{'assets/jobs/' + unit.jobsData[i].image + '.png'}}" />
              {{ unit.jobsData[i].name }}
            </div>
          </td>
        </tr>
        <tr>
          <th class="sub">Equipment</th>
        </tr>
        <tr>
          <td>
            <div class="equipmentDiv">
              Slot 1
              <div *ngIf="unit && unit.equipments && unit.equipments[0]" (click)="openEquipmentsModal(0)" class="equipmentPointer">
                <img src="{{'assets/equipments/' + unit.equipments[0].image + '.png'}}" class="equipmentImg background_{{ unit.equipments[0].category }}"/>
              </div>
              <div *ngIf="!unit.equipments || !unit.equipments[0]" (click)="openEquipmentsModal(0)" class="equipmentPointer">
                <img src="{{'assets/builder/no_artifact.png'}}" class="equipmentImg"/>
              </div>
              <button class="btn btn-sub btn-equipment" [ngClass]="{'btn-disable': !unit.equipments || !unit.equipments[0]}" (click)="openEquipmentsModal(0)">Custom</button>
            </div>

            <div class="equipmentDiv" *ngIf="unit && unit.lb >= 2">
              Slot 2
              <div *ngIf="unit && unit.equipments && unit.equipments[1]" (click)="openEquipmentsModal(1)" class="equipmentPointer">
                <img src="{{'assets/equipments/' + unit.equipments[1].image + '.png'}}" class="equipmentImg background_{{ unit.equipments[1].category }}"/>
              </div>
              <div *ngIf="!unit.equipments || !unit.equipments[1]" (click)="openEquipmentsModal(1)" class="equipmentPointer">
                <img src="{{'assets/builder/no_artifact.png'}}" class="equipmentImg"/>
              </div>
              <button class="btn btn-sub btn-equipment" [ngClass]="{'btn-disable': !unit.equipments || !unit.equipments[1]}" (click)="openEquipmentsModal(1)">Custom</button>
            </div>

            <div class="equipmentDiv" *ngIf="unit && (unit.lb < 2 || !unit.lb)">
              Slot 2
              <img src="{{'assets/builder/lock_artifact.png'}}" class="equipmentImg"/>
              <button class="btn btn-sub btn-disable btn-equipment">Custom</button>
            </div>

            <div class="equipmentDiv" *ngIf="unit && unit.lb >= 4">
              TMR
              <div *ngIf="unit && unit.equipments && unit.equipments[2]" (click)="openEquipmentsModal(2)" class="equipmentPointer">
                <img src="{{'assets/equipments/' + unit.equipments[2].image + '.png'}}" class="equipmentImg background_{{ unit.equipments[2].category }}"/>
              </div>
              <div *ngIf="!unit.equipments || !unit.equipments[2]" (click)="openEquipmentsModal(2)" class="equipmentPointer">
                <img src="{{'assets/builder/no_artifact.png'}}" class="equipmentImg"/>
              </div>
              <button class="btn btn-sub btn-equipment" [ngClass]="{'btn-disable': !unit.equipments || !unit.equipments[2]}" (click)="openEquipmentsModal(2)">Custom</button>
            </div>

            <div class="equipmentDiv" *ngIf="unit && (unit.lb < 4 || !unit.lb)">
              TMR
              <img src="{{'assets/builder/lock_artifact.png'}}" class="equipmentImg"/>
              <button class="btn btn-sub btn-disable btn-equipment">Custom</button>
            </div>
          </td>
        </tr>
        <tr>
          <th class="sub">Esper & Card</th>
        </tr>
        <tr>
          <td>
            <div class="esparCardDiv">
              Esper
              <div *ngIf="unit.esper">
                <img src="{{'assets/units/' + unit.esper.image + '_m.png'}}" class="esperImg" (click)="openEspersModal()"/>
                Reso
                <div ngbDropdown class="dropdownDiv">
                  <button class="btn btn-select" ngbDropdownToggle>{{ unit.esper.resonance }}</button>
                  <div ngbDropdownMenu class="selectList">
                    <button *ngFor="let level of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]" class="selectLevel" ngbDropdownItem (focus)="selectEsperResonance(level)">{{ level }}</button>
                  </div>
                </div>
                <button class="btn btn-sub btn-esper" (click)="openEspersModal()">Custom</button>
              </div>

              <div *ngIf="!unit.esper">
                <img src="{{'assets/builder/no_esper.png'}}" class="esperImg" (click)="openEspersModal()"/>
                <button class="btn btn-sub btn-disable btn-esper" (click)="openEspersModal()">Custom</button>
              </div>
            </div>

            <div class="esparCardDiv">
              Vision Card
              <div *ngIf="unit.card">
                <img src="{{'assets/cards/' + unit.card.image + '_m.png'}}" class="cardImg" (click)="openCardsModal()"/>
                <button class="btn btn-sub btn-card" (click)="openCardsModal()">Custom</button>
              </div>

              <div *ngIf="!unit.card">
                <img src="{{'assets/builder/no_card.png'}}" class="cardImg" (click)="openCardsModal()"/>
                <button class="btn btn-sub btn-disable btn-card" (click)="openCardsModal()">Custom</button>
              </div>
            </div>
          </td>
        </tr>
        <tr>
          <th class="sub">Support Skills</th>
        </tr>
        <tr *ngFor="let i of [0, 1]">
          <td>
            <div ngbDropdown class="dropdownFull">
              <button class="btn btn-select" ngbDropdownToggle>
                {{ unit.activatedSupport[i] && unit.activatedSupport[i] > 0 ? unit.board.nodes[unit.activatedSupport[i]].skill.name : "Select a skill" }}
              </button>
              <div ngbDropdownMenu class="selectList selectListFull">
                <button *ngFor="let node of getAvailableSupportNodes(i)" class="selectLevel" ngbDropdownItem (focus)="selectSupportSkill(i, node.nodeId)">{{ node.name }}</button>
              </div>
            </div>
          </td>
        </tr>
        <tr>
          <th class="sub">Counter Skill</th>
        </tr>
        <tr>
          <td>
            <div ngbDropdown class="dropdownFull">
              <button class="btn btn-select" ngbDropdownToggle>
                {{ unit.activatedCounter && unit.activatedCounter > 0 ? unit.board.nodes[unit.activatedCounter].skill.name : "Select a skill" }}
              </button>
              <div ngbDropdownMenu class="selectList selectListFull">
                <button *ngFor="let node of getAvailableCounterNodes()" class="selectLevel" ngbDropdownItem (focus)="selectCounterSkill(node.nodeId)">{{ node.name }}</button>
              </div>
            </div>
          </td>
        </tr>
        <tr>
          <th class="sub">Guild</th>
        </tr>
        <tr>
          <td>
            <div *ngFor="let statue of statueNames" class="guildDiv">
              <img class="statueImg" src="{{ 'assets/statues/' + statue + '.png' }}"/>
              {{ unit.guild.data[statue] }}
            </div>
            <div>
              <button class="btn btn-sub btn-guild" (click)="showGuildDetail()">Custom</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="rightBlock" *ngIf="!showList && unit">
    <table class="statsTable">
      <tbody>
        <tr>
          <th colspan="14">Stats</th>
        </tr>
        <tr>
          <th class="sub"></th>
          <th class="sub" *ngFor="let type of statsType">{{ type }}</th>
          <th class="sub">COST</th>
        </tr>
      </tbody>
      <tbody *ngIf="showStatsDetail">
        <tr *ngFor="let statFrom of statsFrom">
          <td>{{ statFrom.translate }}</td>
          <td *ngFor="let type of statsType">
            <span *ngIf="type == 'AP' && unit.stats['INITIAL_AP'][statFrom.type]">{{ unit.stats["INITIAL_AP"][statFrom.type] }} / </span>
            <span>{{ unit.stats[type][statFrom.type] }}</span>
          </td>
          <td>
            <span *ngIf="unit.calcCost && unit.calcCost[statFrom.type]">{{ unit.calcCost[statFrom.type] }}</span>
          </td>
        </tr>

        <tr *ngFor="let statFrom of [0, 1, 2]">
          <td>Equipment {{ statFrom }} Stats</td>
          <td *ngFor="let type of statsType">
            <div *ngIf="unit.stats[type].equipments">
              <span *ngIf="type == 'AP' && unit.stats['INITIAL_AP'].equipments[statFrom]">{{ unit.stats["INITIAL_AP"].equipments[statFrom] }} / </span>
              <span>{{ unit.stats[type].equipments[statFrom] }}</span>
            </div>
          </td>
          <td></td>
        </tr>

        <tr *ngFor="let statFrom of [0, 1, 2]">
          <td>Equipment {{ statFrom }} Buffs</td>
          <td *ngFor="let type of statsType">
            <span *ngIf="type == 'AP' && unit.stats['INITIAL_AP']['equipment' + statFrom + '_buff']">{{ unit.stats["INITIAL_AP"]['equipment' + statFrom + '_buff'] }} / </span>
            <span>{{ unit.stats[type]['equipment' + statFrom + '_buff'] }}</span>
          </td>
          <td></td>
        </tr>

        <tr>
          <td>Total Equipement</td>
          <td *ngFor="let type of statsType">
            <span *ngIf="type == 'AP' && unit.stats['INITIAL_AP']['totalEquipment']">{{ unit.stats["INITIAL_AP"]['totalEquipment'] }} / </span>
            <span>{{ unit.stats[type]['totalEquipment'] }}</span>
          </td>
          <td></td>
        </tr>
      </tbody>
      <tbody>
        <tr>
          <td>Total</td>
          <td *ngFor="let type of statsType">
            <span *ngIf="type == 'AP'">{{ unit.stats["INITIAL_AP"].total }} / </span>
            <span>{{ unit.stats[type].total }}</span>
          </td>
          <td>{{ unit.calcCost ? unit.calcCost.total : 0 }}</td>
        </tr>
      </tbody>
    </table>
    <button class="btn btn-sub btn-detail" (click)="showHideDetail('Stats')">Stats Detail</button>

    <table class="buffsTable">
      <tbody>
        <tr>
          <th colspan="9">Buffs</th>
        </tr>
      </tbody>
      <tbody *ngFor="let line of getAvailableStatType()">
        <tr>
          <th class="sub"></th>
          <th class="sub" *ngFor="let statType of line">
            <img *ngIf="buffsImage.indexOf(statType.toLowerCase()) !== -1" class="buffImg" title="{{ statType }}" src="{{ '/assets/buffs/' + statType.toLowerCase() + '.png' }}">
            <span *ngIf="buffsImage.indexOf(statType.toLowerCase()) === -1">{{ statType }}</span>
          </th>
        </tr>
        <tr [ngClass]="{'disable': !showBuffsDetail}" *ngFor="let comeFrom of buffsFrom">
          <td>{{ comeFrom.translate }}</td>
          <td *ngFor="let statType of line">{{ unit.stats[statType] ? unit.stats[statType][comeFrom.type] : '' }}</td>
        </tr>

        <tr [ngClass]="{'disable': !showBuffsDetail}" *ngFor="let statFrom of [0, 1, 2]">
          <td>Equipment {{ statFrom }} Stats</td>
          <td *ngFor="let statType of line">
            <div *ngIf="unit.stats[statType].equipments">
              <span>{{ unit.stats[statType].equipments[statFrom] }}</span>
            </div>
          </td>
        </tr>

        <tr [ngClass]="{'disable': !showBuffsDetail}" *ngFor="let statFrom of [0, 1, 2]">
          <td>Equipment {{ statFrom }} Buffs</td>
          <td *ngFor="let statType of line">
            <span>{{ unit.stats[statType]['equipment' + statFrom + '_buff'] }}</span>
          </td>
        </tr>

        <tr  [ngClass]="{'disable': !showBuffsDetail}" >
          <td>Total Equipement</td>
          <td *ngFor="let statType of line">
            <span>{{ unit.stats[statType]['totalEquipment'] }}</span>
          </td>
        </tr>

        <tr>
          <td>Total</td>
          <td *ngFor="let statType of line">{{ unit.stats[statType].total }}</td>
        </tr>
      </tbody>
    </table>
    <button class="btn btn-sub btn-detail" (click)="showHideDetail('Buffs')">Buffs Detail</button>


    <table class="imbueTable" *ngIf="unit.imbue">
      <tbody>
        <tr>
          <th colspan="9">Imbue</th>
        </tr>
        <tr>
          <td>
            {{ unit.imbue.formatHtml }}
          </td>
        </tr>
      </tbody>
    </table>

    <div class="skillsBlock">
      <div class="skillTitle">
        Active Skills
      </div>
      <div class="skillSubTitle" (click)="isCollapsedMainJob = !isCollapsedMainJob" [attr.aria-expanded]="!isCollapsedMainJob">
        Main Job
        <i class="fas fa-chevron-up" *ngIf="!isCollapsedMainJob" aria-hidden="true"></i>
        <i class="fas fa-chevron-down" *ngIf="isCollapsedMainJob" aria-hidden="true"></i>
      </div>
      <div class="collapsedSkills" [ngbCollapse]="isCollapsedMainJob">
        <table class="skillsTable">
          <tr>
            <th class="sub skillTypeTd">Type</th>
            <th class="sub skillNameTd">Name</th>
            <th class="sub ">Effects</th>
            <th class="sub rangeTd">Range</th>
            <th class="sub skillCastTd">Casts</th>
            <th class="sub skillHitTd">Hits</th>
            <th class="sub skillCostTd">Cost</th>
          </tr>
          <tr *ngFor="let skill of getSkillsPerJob('main')">
            <td>
              <img class="skilImg" title="skill type" src="{{'assets/skill-type/' + skill.type + '.png'}}" />
              <span *ngIf="skill.based"><img title="{{ skill.based }}" class='atkBasedImg' src="{{'assets/atkBased/' + skill.based + '.png'}}" /></span>
              <div *ngIf="skill.time && skill.time.minValue">
                <ng-template #tip_time>
                  <div>
                    Min time: {{ skill.time.minValue }}<br />
                    Max time: {{ skill.time.maxValue }}
                  </div>
                </ng-template>
                <img class='timeImg' src="{{'assets/icons/time.png'}}" [ngbTooltip]="tip_time"/>
              </div>
            </td>
            <td>{{ skill.name }}</td>
            <td class="skillEffectTd">
              <div>{{ skill.counterHtml }}</div>
              <div [innerHTML]="skill.damageHtml"></div>
              <div *ngFor="let effect of skill.effects">
                {{ effect.formatHtml }}
              </div>
            </td>
            <td>
              <ng-template #tip_table><div [innerHTML]="skill.skillTableHtml"></div></ng-template>
              <div [ngbTooltip]="tip_table" triggers="click" [autoClose]="true">
                <div class="divSkillTableHtml" [innerHTML]="skill.skillTableHtml"></div>
              </div>
            </td>
            <td>{{ skill.count }}</td>
            <td><span *ngIf="skill.combo">{{ skill.combo.num }}</span></td>
            <td><span *ngIf="skill.cost">{{ skill.cost.value }} {{ skill.cost.type }}</span></td>
          </tr>
        </table>
      </div>
      <div class="skillSubTitle" (click)="isCollapsedSubJob = !isCollapsedSubJob" [attr.aria-expanded]="!isCollapsedSubJob">
        Sub Job
        <i class="fas fa-chevron-up" *ngIf="!isCollapsedSubJob" aria-hidden="true"></i>
        <i class="fas fa-chevron-down" *ngIf="isCollapsedSubJob" aria-hidden="true"></i>
      </div>
      <div class="collapsedSkills" [ngbCollapse]="isCollapsedSubJob">
        <table class="skillsTable">
          <tr>
            <th class="sub skillTypeTd">Type</th>
            <th class="sub skillNameTd">Name</th>
            <th class="sub ">Effects</th>
            <th class="sub rangeTd">Range</th>
            <th class="sub skillCastTd">Casts</th>
            <th class="sub skillHitTd">Hits</th>
            <th class="sub skillCostTd">Cost</th>
          </tr>
          <tr *ngFor="let skill of getSkillsPerJob('sub')">
            <td>
              <img class="skilImg" title="skill type" src="{{'assets/skill-type/' + skill.type + '.png'}}" />
              <span *ngIf="skill.based"><img title="{{ skill.based }}" class='atkBasedImg' src="{{'assets/atkBased/' + skill.based + '.png'}}" /></span>
              <div *ngIf="skill.time && skill.time.minValue">
                <ng-template #tip_time>
                  <div>
                    Min time: {{ skill.time.minValue }}<br />
                    Max time: {{ skill.time.maxValue }}
                  </div>
                </ng-template>
                <img class='timeImg' src="{{'assets/icons/time.png'}}" [ngbTooltip]="tip_time"/>
              </div>
            </td>
            <td>{{ skill.name }}</td>
            <td class="skillEffectTd">
              <div>{{ skill.counterHtml }}</div>
              <div [innerHTML]="skill.damageHtml"></div>
              <div *ngFor="let effect of skill.effects">
                {{ effect.formatHtml }}
              </div>
            </td>
            <td>
              <ng-template #tip_table><div [innerHTML]="skill.skillTableHtml"></div></ng-template>
              <div [ngbTooltip]="tip_table" triggers="click" [autoClose]="true">
                <div class="divSkillTableHtml" [innerHTML]="skill.skillTableHtml"></div>
              </div>
            </td>
            <td>{{ skill.count }}</td>
            <td><span *ngIf="skill.combo">{{ skill.combo.num }}</span></td>
            <td><span *ngIf="skill.cost">{{ skill.cost.value }} {{ skill.cost.type }}</span></td>
          </tr>
        </table>
      </div>

      <div class="skillSubTitle" (click)="isCollapsedOther = !isCollapsedOther" [attr.aria-expanded]="!isCollapsedOther">
        Other Skills
        <i class="fas fa-chevron-up" *ngIf="!isCollapsedOther" aria-hidden="true"></i>
        <i class="fas fa-chevron-down" *ngIf="isCollapsedOther" aria-hidden="true"></i>
      </div>
      <div class="collapsedSkills" [ngbCollapse]="isCollapsedOther">
        <table class="skillsTable">
          <tr>
            <th class="sub skillTypeTd">Type</th>
            <th class="sub skillNameTd">Name</th>
            <th class="sub ">Effects</th>
            <th class="sub rangeTd">Range</th>
            <th class="sub skillCastTd">Casts</th>
            <th class="sub skillHitTd">Hits</th>
            <th class="sub skillCostTd">Cost</th>
          </tr>
          <tbody *ngFor="let i of [0, 1, 2]">
            <tr *ngIf="unit.equipments[i] && unit.equipments[i].activeSkill; let skill">
              <td>
                <img class="skilImg" title="skill type" src="{{'assets/skill-type/weapon.png'}}" />
                <span *ngIf="skill.based"><img title="{{ skill.based }}" class='atkBasedImg' src="{{'assets/atkBased/' + skill.based + '.png'}}" /></span>
                <div *ngIf="skill.time && skill.time.minValue">
                  <ng-template #tip_time>
                    <div>
                      Min time: {{ skill.time.minValue }}<br />
                      Max time: {{ skill.time.maxValue }}
                    </div>
                  </ng-template>
                  <img class='timeImg' src="{{'assets/icons/time.png'}}" [ngbTooltip]="tip_time"/>
                </div>
              </td>
              <td>{{ skill.name }}</td>
              <td class="skillEffectTd">
                <div>{{ skill.counterHtml }}</div>
                <div [innerHTML]="skill.damageHtml"></div>
                <div *ngFor="let effect of skill.effects">
                  {{ effect.formatHtml }}
                </div>
              </td>
              <td>
                <ng-template #tip_table><div [innerHTML]="skill.skillTableHtml"></div></ng-template>
                <div [ngbTooltip]="tip_table" triggers="click" [autoClose]="true">
                  <div class="divSkillTableHtml" [innerHTML]="skill.skillTableHtml"></div>
                </div>
              </td>
              <td>{{ skill.count }}</td>
              <td><span *ngIf="skill.combo">{{ skill.combo.num }}</span></td>
              <td><span *ngIf="skill.cost">{{ skill.cost.value }} {{ skill.cost.type }}</span></td>
            </tr>
          </tbody>
          <tbody *ngIf="unit.activatedSupport[0] !== '0'">
            <tr *ngFor="let skill of [unit.board.nodes[unit.activatedSupport[0]].skill]">
              <td>
                <img class="skilImg" title="skill type" src="{{'assets/skill-type/support.png'}}" />
                <span *ngIf="skill.based"><img title="{{ skill.based }}" class='atkBasedImg' src="{{'assets/atkBased/' + skill.based + '.png'}}" /></span>
                <div *ngIf="skill.time && skill.time.minValue">
                  <ng-template #tip_time>
                    <div>
                      Min time: {{ skill.time.minValue }}<br />
                      Max time: {{ skill.time.maxValue }}
                    </div>
                  </ng-template>
                  <img class='timeImg' src="{{'assets/icons/time.png'}}" [ngbTooltip]="tip_time"/>
                </div>
              </td>
              <td>{{ skill.name }}</td>
              <td class="skillEffectTd">
                <div>{{ skill.counterHtml }}</div>
                <div [innerHTML]="skill.damageHtml"></div>
                <div *ngFor="let effect of skill.effects">
                  {{ effect.formatHtml }}
                </div>
              </td>
              <td>
                <ng-template #tip_table><div [innerHTML]="skill.skillTableHtml"></div></ng-template>
                <div [ngbTooltip]="tip_table" triggers="click" [autoClose]="true">
                  <div class="divSkillTableHtml" [innerHTML]="skill.skillTableHtml"></div>
                </div>
              </td>
              <td>{{ skill.count }}</td>
              <td><span *ngIf="skill.combo">{{ skill.combo.num }}</span></td>
              <td><span *ngIf="skill.cost">{{ skill.cost.value }} {{ skill.cost.type }}</span></td>
            </tr>
          </tbody>
          <tbody *ngIf="unit.activatedSupport[1] !== '0'">
            <tr *ngFor="let skill of [unit.board.nodes[unit.activatedSupport[1]].skill]">
              <td>
                <img class="skilImg" title="skill type" src="{{'assets/skill-type/support.png'}}" />
                <span *ngIf="skill.based"><img title="{{ skill.based }}" class='atkBasedImg' src="{{'assets/atkBased/' + skill.based + '.png'}}" /></span>
                <div *ngIf="skill.time && skill.time.minValue">
                  <ng-template #tip_time>
                    <div>
                      Min time: {{ skill.time.minValue }}<br />
                      Max time: {{ skill.time.maxValue }}
                    </div>
                  </ng-template>
                  <img class='timeImg' src="{{'assets/icons/time.png'}}" [ngbTooltip]="tip_time"/>
                </div>
              </td>
              <td>{{ skill.name }}</td>
              <td class="skillEffectTd">
                <div>{{ skill.counterHtml }}</div>
                <div [innerHTML]="skill.damageHtml"></div>
                <div *ngFor="let effect of skill.effects">
                  {{ effect.formatHtml }}
                </div>
              </td>
              <td>
                <ng-template #tip_table><div [innerHTML]="skill.skillTableHtml"></div></ng-template>
                <div [ngbTooltip]="tip_table" triggers="click" [autoClose]="true">
                  <div class="divSkillTableHtml" [innerHTML]="skill.skillTableHtml"></div>
                </div>
              </td>
              <td>{{ skill.count }}</td>
              <td><span *ngIf="skill.combo">{{ skill.combo.num }}</span></td>
              <td><span *ngIf="skill.cost">{{ skill.cost.value }} {{ skill.cost.type }}</span></td>
            </tr>
          </tbody>
          <tbody *ngIf="unit.activatedCounter !== '0'">
            <tr *ngFor="let skill of [unit.board.nodes[unit.activatedCounter].skill]">
              <td>
                <img class="skilImg" title="skill type" src="{{'assets/skill-type/counter.png'}}" />
                <span *ngIf="skill.based"><img title="{{ skill.based }}" class='atkBasedImg' src="{{'assets/atkBased/' + skill.based + '.png'}}" /></span>
                <div *ngIf="skill.time && skill.time.minValue">
                  <ng-template #tip_time>
                    <div>
                      Min time: {{ skill.time.minValue }}<br />
                      Max time: {{ skill.time.maxValue }}
                    </div>
                  </ng-template>
                  <img class='timeImg' src="{{'assets/icons/time.png'}}" [ngbTooltip]="tip_time"/>
                </div>
              </td>
              <td>{{ skill.name }}</td>
              <td class="skillEffectTd">
                <div>{{ skill.counterHtml }}</div>
                <div [innerHTML]="skill.damageHtml"></div>
                <div *ngFor="let effect of skill.effects">
                  {{ effect.formatHtml }}
                </div>
              </td>
              <td>
                <ng-template #tip_table><div [innerHTML]="skill.skillTableHtml"></div></ng-template>
                <div [ngbTooltip]="tip_table" triggers="click" [autoClose]="true">
                  <div class="divSkillTableHtml" [innerHTML]="skill.skillTableHtml"></div>
                </div>
              </td>
              <td>{{ skill.count }}</td>
              <td><span *ngIf="skill.combo">{{ skill.combo.num }}</span></td>
              <td><span *ngIf="skill.cost">{{ skill.cost.value }} {{ skill.cost.type }}</span></td>
            </tr>
          </tbody>
          <tbody *ngIf="unit.limit">
            <tr>
              <td>
                <img class="skilImg" title="skill type" src="{{'assets/skill-type/limit.png'}}" />
                <span *ngIf="unit.limit.based"><img title="{{ unit.limit.based }}" class='atkBasedImg' src="{{'assets/atkBased/' + unit.limit.based + '.png'}}" /></span>
                <div *ngIf="unit.limit.time && unit.limit.time.minValue">
                  <ng-template #tip_time>
                    <div>
                      Min time: {{ unit.limit.time.minValue }}<br />
                      Max time: {{ unit.limit.time.maxValue }}
                    </div>
                  </ng-template>
                  <img class='timeImg' src="{{'assets/icons/time.png'}}" [ngbTooltip]="tip_time"/>
                </div>
              </td>
              <td>{{ unit.limit.name }}</td>
              <td class="skillEffectTd">
                <div>{{ unit.limit.counterHtml }}</div>
                <div [innerHTML]="unit.limit.damageHtml"></div>
                <div *ngFor="let effect of unit.limit.effects">
                  {{ effect.formatHtml }}
                </div>
              </td>
              <td>
                <ng-template #tip_table><div [innerHTML]="unit.limit.skillTableHtml"></div></ng-template>
                <div [ngbTooltip]="tip_table" triggers="click" [autoClose]="true">
                  <div class="divSkillTableHtml" [innerHTML]="unit.limit.skillTableHtml"></div>
                </div>
              </td>
              <td>{{ unit.limit.count }}</td>
              <td><span *ngIf="unit.limit.combo">{{ unit.limit.combo.num }}</span></td>
              <td><span *ngIf="unit.limit.cost">{{ unit.limit.cost.value }} {{ unit.limit.cost.type }}</span></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="treeTitle">
      Skill Tree
    </div>

    <div class="builderUnitGridContainer">
      <ul class="hexGrid" oncontextmenu="return false;">
        <li *ngFor="let node of unit.grid.gridNodes; let index;" (click)="clickNode(node)" (contextmenu)="rightClickNode(node)">
          <div class="hex hideNode" *ngIf="unit.grid.nodesForGrid[node].type == 'hidden'">{{ node }}</div>

          <div class="hex activated" *ngIf="unit.grid.nodesForGrid[node].type == 'center'">
            <span class="fullIcon"><img src="{{ '/assets/units/' + unit.image + '_m.png' }}"></span>
          </div>

          <div class="hex" *ngIf="unit.grid.nodesForGrid[node].type == 'text'"
               [ngClass]="{
                 'activated': unit.board.nodes[node].activated,
                 'buff': unit.board.nodes[node].type == 'buff',
                 'skill': unit.board.nodes[node].type == 'skill' && unit.board.nodes[node].skill.type == 'skill',
                 'support': unit.board.nodes[node].type == 'skill' && unit.board.nodes[node].skill.type == 'support',
                 'counter': unit.board.nodes[node].type == 'skill' && unit.board.nodes[node].skill.type == 'counter',
                 'notActivable': !canActivateNode(node)
          }" >
            <i class="fas fa-plus" *ngIf="unit.grid.nodesForGrid[node].subType == 'skill' && unit.board.nodes[node].activated"></i>
            <span class="text">{{ unit.grid.nodesForGrid[node].value }}</span>
            <span class="skillLevel" *ngIf="unit.grid.nodesForGrid[node].subType == 'skill' && unit.board.nodes[node].activated">lv. {{ unit.board.nodes[node].level == unit.board.nodes[node].skill.maxLevel ? 'MAX' : unit.board.nodes[node].level }}</span>
            <i class="fas fa-minus" *ngIf="unit.grid.nodesForGrid[node].subType == 'skill' && unit.board.nodes[node].activated" (click)="rightClickNode(node); $event.stopPropagation()"></i>
          </div>
        </li>
      </ul>

      <div [innerHTML]="unit.grid.lines | safeHtml"></div>
    </div>
  </div>
</div>
